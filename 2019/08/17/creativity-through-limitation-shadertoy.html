<!DOCTYPE html>
<html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-104711057-2"></script>
	<script>
  	window.dataLayer = window.dataLayer || [];
  	function gtag(){dataLayer.push(arguments);}
  	gtag('js', new Date());
  	gtag('config', 'UA-104711057-2');
	</script><meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/assets/favicon-96x96.png">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:600|PT+Serif|Source+Code+Pro&display=swap" rel="stylesheet"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Creativity through limitation: Shadertoy | Megus</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Creativity through limitation: Shadertoy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Shadertoy is a place where anyone can share realtime procedural graphics experiments. This article is an introduction to procedural graphics and ray tracing." />
<meta property="og:description" content="Shadertoy is a place where anyone can share realtime procedural graphics experiments. This article is an introduction to procedural graphics and ray tracing." />
<link rel="canonical" href="https://megus.org/2019/08/17/creativity-through-limitation-shadertoy.html" />
<meta property="og:url" content="https://megus.org/2019/08/17/creativity-through-limitation-shadertoy.html" />
<meta property="og:site_name" content="Megus" />
<meta property="og:image" content="https://megus.org/assets/blog-images/2019-08-17-cover.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-08-17T00:00:00-07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@sugem" />
<meta name="twitter:creator" content="@sugem" />
<script type="application/ld+json">
{"url":"https://megus.org/2019/08/17/creativity-through-limitation-shadertoy.html","headline":"Creativity through limitation: Shadertoy","dateModified":"2019-08-17T00:00:00-07:00","datePublished":"2019-08-17T00:00:00-07:00","image":"https://megus.org/assets/blog-images/2019-08-17-cover.jpg","description":"Shadertoy is a place where anyone can share realtime procedural graphics experiments. This article is an introduction to procedural graphics and ray tracing.","mainEntityOfPage":{"@type":"WebPage","@id":"https://megus.org/2019/08/17/creativity-through-limitation-shadertoy.html"},"@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://megus.org/feed.xml" title="Megus" /></head>
<body><header class="site-header" role="banner">
  <div class="site-header-wrapper"><a href="/"><img class="site-logo" src="/assets/megus-logo-circle.png" />
    <span class="site-title" rel="author">Megus</span></a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">About</a><a class="page-link" href="/portfolio.html">Portfolio</a><a class="page-link" href="/music.html">Music</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.3&appId=194003690636360&autoLogAppEvents=1"></script>
<script>window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
  
    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };
  
    return t;
  }(document, "script", "twitter-wjs"));</script>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header"><div class="post-cover" style="background-image: url(/assets/blog-images/2019-08-17-cover.jpg)">
        <div class="gradient">
          <img hidden itemprop="image" src="/assets/blog-images/2019-08-17-cover.jpg" />
          <h1 class="post-cover-title p-name" itemprop="name headline">Creativity through limitation: Shadertoy</h1>
        </div>
      </div><p class="post-meta">
      <time class="dt-published" datetime="2019-08-17T00:00:00-07:00" itemprop="datePublished">Aug 17, 2019
      </time>
    </p>
    <span hidden itemscope itemtype="http://schema.org/Person" itemprop="author">
      <span hidden itemprop="name">Roman "Megus" Petrov</span>
    </span>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This is the third article in “Creativity through limitation” series. In case you missed the previous ones:</p>

<ul>
  <li><a href="/2018/08/05/creativity-through-limitation-8-bit-demoscene.html">8-bit demoscene</a></li>
  <li><a href="/2019/06/18/creativity-through-limitation-pico-8.html">PICO-8 — Fantasy console</a></li>
</ul>

<p>When I first learned about <a href="https://www.shadertoy.com">Shadertoy</a> and browsed through some works there, my reaction was: “HOW???!!!” I already knew what shaders are because I’m interested in computer graphics and learned OpenGL basics. This knowledge only amplified my fascination.</p>

<p>Shadertoy is a place where anyone can share their experiments with realtime procedural computer graphics. It is created by <a href="http://iquilezles.org/index.html">Inigo Quilez</a> (a demoscener and a former Pixar employee) and <a href="http://www.poljeremias.com">Pol Jeremias</a> (currently working at Pixar). It uses WebGL, so everything runs right in a browser.</p>

<p>Here’s an example of what people do:</p>

<iframe width="640" height="360" frameborder="0" src="https://www.shadertoy.com/embed/XsBXWt?gui=true&amp;t=10&amp;paused=true&amp;muted=false" allowfullscreen=""></iframe>

<p class="footnote">Click the “play” button to see it in action.</p>

<p>You may think that it looks pretty simple compared to, for example, the latest video games. Let me give you a quick high-level introduction to 3D graphics (CG-pros, if you read it, don’t blame me for the oversimplification, please). To draw some 3D object, you need to model it with triangles, define transformations (rotation, scaling, projection, etc.) and then use some shader magic. Shaders are small programs running on GPU — graphics processing unit on a video card. First, you pass all polygon vertices and transformations to vertex shaders. They convert 3D coordinates to 2D screen coordinates and pass all data to a rasterizer. Rasterizer draws triangles and calls fragment shaders for each pixel to get the color.</p>

<p>Sounds simple? Then remove everything but a fragment shader. The only input you have now is a coordinate on a screen. Try to think about how to draw a 3D cube. Shaders run in parallel on multiple GPU cores, so you can’t have any state to pass between shader calls while drawing a single frame. Shaders are just like functions in functional programming languages, or mathematical functions — they can’t have side effects. Does it sound challenging and limiting now? I believe that your answer is “YES!”</p>

<h2 id="how-to-draw-a-disk-with-a-fragment-shader">How to draw a disk with a fragment shader</h2>

<p>Shaders are written in GLSL language; the syntax is very similar to C. GLSL has a lot of built-in data types and functions to work with vectors and matrices. Writing your first fragment shader is a mind-shifting experience. Even drawing a disk (a filled circle) is a tricky task in the beginning. Let’s do it now.</p>

<p>As you remember, the only input we have in a fragment shader is a screen coordinate. To draw a disk we need to check if this pixel is inside it or not. Let’s remember the definitions:</p>

<blockquote>
  <p>A disk is the region in a plane bounded by a circle.</p>

  <p>A circle is the set of all points in a plane that are at a given distance (the radius) from a given point (the center).</p>
</blockquote>

<p>So, if the distance from the center is less than the radius, then the point is inside the disk, otherwise — it’s outside. To calculate the distance from an origin point, we use the following formula: sqrt(x² + y²). Given that, to draw a disk, we need to check each pixel for sqrt(x² + y²) &lt; r, or x² + y² &lt; r² (it’s the disk formula in Cartesian coordinates). Now let’s look at the shader code:</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">mainImage</span><span class="p">(</span><span class="k">out</span> <span class="kt">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="kt">vec2</span> <span class="n">fragCoord</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Normalize coordinates to (-1, 1) range and correct aspect ratio</span>
    <span class="kt">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">uv</span> <span class="o">*</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

    <span class="c1">// Check if the point is inside the circle</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fragColor</span> <span class="o">=</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">fragColor</span> <span class="o">=</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">fragCoord</code> is the input variable with screen coordinates. For the ease of use, we convert it to a (-1, 1) range. <code class="highlighter-rouge">fragColor</code> is the output variable for a pixel color. <code class="highlighter-rouge">iResolution</code> is a uniform variable — a global value that doesn’t change while drawing a frame. Shadertoy provides some other convenient uniform variables, for example, <code class="highlighter-rouge">iTime</code> — a time passed since shader start in seconds, which you can use for animations.</p>

<iframe frameborder="0" src="https://www.shadertoy.com/embed/wtSXWD?gui=true&amp;t=10&amp;paused=true&amp;muted=false" allowfullscreen=""></iframe>

<h2 id="ray-tracing-with-fragment-shaders">Ray tracing with fragment shaders</h2>

<p>Now let’s do something more complicated — ray tracing.</p>

<blockquote>
  <p>Ray tracing is a rendering technique for generating an image by tracing the path of light as pixels in an image plane and simulating the effects of its encounters with virtual objects — <a href="https://en.wikipedia.org/wiki/Ray_tracing_(graphics)">Wikipedia</a></p>
</blockquote>

<p>I think ray tracing is the best way to draw 3D scenes with fragment shaders because they naturally match the idea of ray tracing. If you read the code of some shaders at Shadertoy, you’ll see that most of them use it in some form.</p>

<p>I wrote my first ray tracing shader for this article, here’s my final result:</p>

<iframe frameborder="0" src="https://www.shadertoy.com/embed/tlXXzB?gui=true&amp;t=10&amp;paused=true&amp;muted=false" allowfullscreen=""></iframe>

<p>My shader doesn’t work in Safari because it doesn’t support WebGL 2 yet. You can enable experimental support from the development menu (Develop → Experimental Features → WebGL 2.0). I’d recommend using Google Chrome with Shadertoy.</p>

<p>You can see the full code at Shadertoy. It’s a fantastic feature of Shadertoy which I love — all code is open, and you can learn from it. I added quite a lot of comments to make it easy to understand for beginners. Here I want to walk through the code and give a bit more details.</p>

<p><code class="highlighter-rouge">mainImage</code> function is pretty straightforward: I normalize screen coordinates, just like in the disk example above, then I set camera position and the ray direction — <code class="highlighter-rouge">camO</code> and <code class="highlighter-rouge">camL</code> variables. All ray tracing code is in the separate function to improve the structure and readability.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="kt">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="kt">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Normalized pixel coordinates (from 0 to 1)</span>
    <span class="kt">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">uv</span> <span class="o">*</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

    <span class="c1">// Camera</span>
    <span class="kt">vec3</span> <span class="n">camO</span> <span class="o">=</span> <span class="kt">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kt">vec3</span> <span class="n">camL</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="kt">vec3</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">7</span><span class="p">));</span>

    <span class="c1">// Ray-tracing</span>
    <span class="n">fragColor</span> <span class="o">=</span> <span class="kt">vec4</span><span class="p">(</span><span class="n">trace</span><span class="p">(</span><span class="n">camO</span><span class="p">,</span> <span class="n">camL</span><span class="p">),</span> <span class="mi">1</span><span class="p">.);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the beginning, I define my scene: a light source, three spheres, and a “floor,” which is yet another sphere, but very big, so it looks almost flat. By the way, this code is why the shader doesn’t work in Safari by default — there’s no array support in WebGL 1.</p>

<p><code class="highlighter-rouge">COUNT</code> is the number of objects, <code class="highlighter-rouge">SIZE</code> is the number of array items for each object. For each sphere, I define the starting position and the radius, color, movement speed, and movement amplitude for each axis. Using arrays in this example is more convenient than adding multiple conditions in the code.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define COUNT 5
#define SIZE 4
</span>
<span class="kt">vec4</span> <span class="n">spheres</span><span class="p">[]</span> <span class="o">=</span> <span class="kt">vec4</span><span class="p">[</span><span class="n">COUNT</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">](</span>
    <span class="c1">// Spheres: center and radius, color, movement speed, movement amplitude</span>
    <span class="c1">// Light source</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="o">-</span><span class="mi">7</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.,</span> <span class="mi">31</span><span class="p">.,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">1</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.),</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">2</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">.,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="c1">// 1</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">.,</span> <span class="mi">0</span><span class="p">.,</span> <span class="mi">39</span><span class="p">.,</span> <span class="mi">2</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(.</span><span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">.),</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">1</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">.,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="c1">// 2</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">3</span><span class="p">.,</span> <span class="mi">0</span><span class="p">.,</span> <span class="mi">42</span><span class="p">.,</span> <span class="mi">3</span><span class="p">.),</span> <span class="kt">vec4</span><span class="p">(.</span><span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">.),</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="c1">// 3</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">.,</span> <span class="mi">43</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(.</span><span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.),</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">2</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.,</span> <span class="mi">2</span><span class="p">.,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="c1">// "Floor"</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">800006</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800000</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="kt">vec4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="kt">vec4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>I want my spheres to move, so the next helper function calculates the position of each sphere at any moment. I moved this code to a separate function because I use it in multiple places. I use <code class="highlighter-rouge">iTime</code> uniform variable to do the animation. I used <code class="highlighter-rouge">cos</code> instead of <code class="highlighter-rouge">sin</code> for Z-axis to do circular flying trajectory for a blue ball. I could add another object parameter in the array above for the phase shift for each axis but decided to keep it simple.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">vec3</span> <span class="nf">sphereCenter</span><span class="p">(</span><span class="kt">int</span> <span class="n">sphere</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">vec4</span> <span class="n">sD</span> <span class="o">=</span> <span class="n">spheres</span><span class="p">[</span><span class="n">sphere</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">];</span>
    <span class="kt">vec4</span> <span class="n">sS</span> <span class="o">=</span> <span class="n">spheres</span><span class="p">[</span><span class="n">sphere</span> <span class="o">*</span> <span class="n">SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
    <span class="kt">vec4</span> <span class="n">sA</span> <span class="o">=</span> <span class="n">spheres</span><span class="p">[</span><span class="n">sphere</span> <span class="o">*</span> <span class="n">SIZE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
    <span class="kt">vec3</span> <span class="n">c</span> <span class="o">=</span> <span class="kt">vec3</span><span class="p">(</span>
        <span class="n">sD</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">iTime</span> <span class="o">*</span> <span class="n">sS</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">sA</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">sD</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">iTime</span> <span class="o">*</span> <span class="n">sS</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">sA</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
        <span class="n">sD</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">iTime</span> <span class="o">*</span> <span class="n">sS</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">sA</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">findIntersection</code> is a crucial function. It finds the intersection between a ray and a sphere and returns sphere number and distance between the ray origin point (<code class="highlighter-rouge">o</code>) and the intersection point. The ray can intersect multiple spheres in multiple points, but we need only the nearest intersection point. I took the formula for a line-sphere intersection from <a href="https://en.wikipedia.org/wiki/Line%E2%80%93sphere_intersection">this Wikipedia article</a>, so I won’t dig into the details here. <code class="highlighter-rouge">ignore</code> variable allows me to ignore a single sphere from checking intersections, I use it for shadows.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">findIntersection</span><span class="p">(</span><span class="kt">vec3</span> <span class="n">o</span><span class="p">,</span> <span class="kt">vec3</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">,</span> <span class="k">out</span> <span class="kt">float</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sphere</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">1e5</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ignore</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">vec3</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sphereCenter</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">spheres</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">SIZE</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>

        <span class="c1">// Ray-sphere intersection formula</span>
        <span class="kt">vec3</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">t1l</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">t1</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">s</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1l</span> <span class="o">*</span> <span class="n">t1l</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">.)</span> <span class="p">{</span>
            <span class="kt">float</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">-</span><span class="n">t2</span> <span class="o">+</span> <span class="n">ss</span><span class="p">,</span> <span class="o">-</span><span class="n">t2</span> <span class="o">-</span> <span class="n">ss</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">.</span> <span class="o">&amp;&amp;</span> <span class="n">sd</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sphere</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sphere</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">trace</code> function connects all the pieces. It traces a single ray (<code class="highlighter-rouge">camO</code> is the origin, <code class="highlighter-rouge">camL</code> is the direction) for a screen pixel and returns a color value for this pixel. We check if there’s any sphere in this direction; if the answer is “yes” — apply lighting to it, otherwise return background color.</p>

<p>The light source is also a sphere, but we don’t need to apply any lighting to it, that’s why there’s a particular check for it.</p>

<p>I combine three lighting elements here (you can see them summed in the final <code class="highlighter-rouge">return</code> statement):</p>

<ul>
  <li>ambient lighting (<code class="highlighter-rouge">aColor</code> variable)</li>
  <li>diffusion lighting</li>
  <li>specular lighting</li>
</ul>

<p>I took all formulas from <a href="http://www.opengl-tutorial.org/beginners-tutorials/tutorial-8-basic-shading/">“Basic shading” OpenGL tutorial</a>, it has clear and easy to understand explanations, so, again, I’m not digging into details here. The only thing I added myself was shadowing — I wanted spheres to cast shadows on other objects. It was easy to do: I trace another ray from an intersection point to the light source, and if there’s something between, then this object is under the shadow.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define LIGHT_POWER 80.
#define SPECULAR_POWER 20.
#define AMBIENT .3
</span>
<span class="kt">vec3</span> <span class="nf">trace</span><span class="p">(</span><span class="kt">vec3</span> <span class="n">camO</span><span class="p">,</span> <span class="kt">vec3</span> <span class="n">camL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.;</span>
    <span class="kt">int</span> <span class="n">sphere</span> <span class="o">=</span> <span class="n">findIntersection</span><span class="p">(</span><span class="n">camO</span><span class="p">,</span> <span class="n">camL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sphere</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// There was no intersection, return background color</span>
        <span class="k">return</span> <span class="kt">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">vec3</span> <span class="n">lightColor</span> <span class="o">=</span> <span class="n">spheres</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">xyz</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sphere</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// It's a light source, don't need to shade it</span>
        <span class="k">return</span> <span class="n">lightColor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">vec3</span> <span class="n">lightPoint</span> <span class="o">=</span> <span class="n">sphereCenter</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Sphere color</span>
    <span class="kt">vec3</span> <span class="n">sColor</span> <span class="o">=</span> <span class="n">spheres</span><span class="p">[</span><span class="n">sphere</span> <span class="o">*</span> <span class="n">SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">xyz</span><span class="p">;</span>
    <span class="kt">vec3</span> <span class="n">aColor</span> <span class="o">=</span> <span class="n">sColor</span> <span class="o">*</span> <span class="kt">vec3</span><span class="p">(</span><span class="n">AMBIENT</span><span class="p">,</span> <span class="n">AMBIENT</span><span class="p">,</span> <span class="n">AMBIENT</span><span class="p">);</span>

    <span class="c1">// Intersection point</span>
    <span class="kt">vec3</span> <span class="n">iPoint</span> <span class="o">=</span> <span class="n">camO</span> <span class="o">+</span> <span class="n">camL</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
    <span class="kt">vec3</span> <span class="n">iNormal</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">iPoint</span> <span class="o">-</span> <span class="n">sphereCenter</span><span class="p">(</span><span class="n">sphere</span><span class="p">));</span>

    <span class="c1">// Light direction vector</span>
    <span class="kt">vec3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightPoint</span> <span class="o">-</span> <span class="n">iPoint</span><span class="p">);</span>

    <span class="c1">// Check if there's another sphere between this one and the light source</span>
    <span class="kt">float</span> <span class="n">dShadow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.;</span>
    <span class="kt">int</span> <span class="n">shadowedBy</span> <span class="o">=</span> <span class="n">findIntersection</span><span class="p">(</span><span class="n">iPoint</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">,</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">dShadow</span><span class="p">);</span>
    <span class="n">dShadow</span> <span class="o">=</span> <span class="kt">float</span><span class="p">(</span><span class="n">shadowedBy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shadowedBy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We're under shadow, use ambient color</span>
        <span class="k">return</span> <span class="n">aColor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Lighting (diffusion and specular)</span>
    <span class="kt">float</span> <span class="n">cosA</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">iNormal</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">),</span> <span class="mi">0</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.);</span>
    <span class="kt">float</span> <span class="n">cosS</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">camL</span><span class="p">,</span> <span class="n">reflect</span><span class="p">(</span><span class="o">-</span><span class="n">lightDir</span><span class="p">,</span> <span class="n">iNormal</span><span class="p">)),</span> <span class="mi">0</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.);</span>

    <span class="kt">float</span> <span class="n">dSquared</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">iPoint</span> <span class="o">-</span> <span class="n">lightPoint</span><span class="p">),</span> <span class="mi">2</span><span class="p">.);</span>

    <span class="k">return</span> <span class="n">aColor</span> <span class="o">+</span>
        <span class="n">sColor</span> <span class="o">*</span> <span class="n">lightColor</span> <span class="o">*</span> <span class="n">cosA</span> <span class="o">*</span> <span class="n">LIGHT_POWER</span> <span class="o">/</span> <span class="n">dSquared</span> <span class="o">+</span>
        <span class="n">lightColor</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">cosS</span><span class="p">,</span> <span class="n">SPECULAR_POWER</span><span class="p">)</span> <span class="o">*</span> <span class="n">LIGHT_POWER</span> <span class="o">/</span> <span class="n">dSquared</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<p>All the math above looked a bit complex to me at first, but when I did everything myself and fixed all the bugs (oh, I had plenty of them!), I grasped it. The next step would be to implement more complex models. One of the main challenges in ray tracing is finding the intersection point. It’s easy for a sphere, but it becomes difficult for other geometrical objects. The good news is that there’s a ray tracing technique called “ray marching” which makes finding intersection point simple even for very complex objects. Initially, I wanted to cover ray marching here, but if I’d done so, the article would have been much longer. If you’re interested in this topic, you may find these links useful:</p>

<ul>
  <li><a href="http://jamie-wong.com/2016/07/15/ray-marching-signed-distance-functions/">“Ray marching and signed distance functions” by Jamie Wong</a> — it was an eye-opener for me, after reading it I understood how many Shadertoy masterpieces work.</li>
  <li><a href="http://iquilezles.org/www/articles/distfunctions/distfunctions.htm">“Primitives” by Inigo Quilez</a> — a reference to signed distance functions.</li>
</ul>

<p>Shadertoy is a fantastic place, and I barely scratched the surface of its features. There’s much more: textures, handling user input, multiple buffers, “sound shaders,” etc. Just go to Shadertoy and explore it! I believe that you’ll find many mind-blowing shaders.</p>

  </div>

  <a class="u-url" href="/2019/08/17/creativity-through-limitation-shadertoy.html" hidden></a>

</article>

<div class="social-buttons">
  <a class="twitter-share-button" data-size="large"
    href="https://twitter.com/intent/tweet?text=Creativity%20through%20limitation:%20Shadertoy&via=sugem">
    Tweet
  </a>
  <div class="fb-share-button" style="top: -7px;"
    data-href="https://megus.org/2019/08/17/creativity-through-limitation-shadertoy.html"
    data-layout="button" data-size="large">
    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&amp;src=sdkpreparse" class="fb-xfbml-parse-ignore">Share</a>
  </div>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        © Roman “Megus” Petrov.<br />
        <a class="u-email" href="mailto:roman.petrov@icloud.com">roman.petrov@icloud.com</a>
      </div>
      <div class="footer-col">
        <a href="https://twitter.com/sugem"><svg viewbox="0 0 16 16" class="social-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a>
        <a href="https://www.facebook.com/sugem"><svg viewbox="0 0 16 16" class="social-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg></a>
        <a href="https://github.com/Megus"><svg viewbox="0 0 16 16" class="social-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a>
        <a href="https://www.youtube.com/user/megussugem"><svg viewbox="0 0 16 16" class="social-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg></a>    
        <a href="https://medium.com/@megus"><svg viewbox="0 0 16 16" class="social-icon"><use xlink:href="/assets/minima-social-icons.svg#medium"></use></svg></a>
      </div>
    </div>
  </div>

</footer>
</body>
</html>
